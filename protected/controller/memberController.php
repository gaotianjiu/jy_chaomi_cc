<?phpclass memberController extends BaseController {    function __construct() {        parent::__construct(); 		$sso_user = check();        if ($sso_user == true) {            $this->uid = $sso_user['uid'];            $this->mid = $sso_user['mid'];        } else {            re_login();            exit();        }        $this->cm_nav='jy';        $this->module='';        $this->act='';        $this->msg_count=0;            }    function actionindex() {        $uid = $this->uid;        $pan_member_domain = spClass('pan_user_domain');        //取所有品种的locked        $sql="select * from (select count(*) as num,locked from cmpai.pan_domain_in  where uid=".$uid." and locked<=15 group by locked with rollup ) t order by locked asc";        $res = $pan_member_domain->query($sql);        if($res){            $nres=array();            foreach($res as $k=>$v){                if(is_null($v['locked'])){                    $nres['all']=$v['num'];                }else {                    $nres[$v['locked']] = $v['num'];                }            }            $res=$nres;        }        $this->res = $res;				//取当前用户，正在提交转入中的域名总数	        $pan_domain_zip_sh = spClass('pan_domain_zip_sh');        // $apply_count = $pan_domain_zip_sh->findCount(array('uid'=>$uid,'audit_status'=>1));        $apply_ret = $pan_domain_zip_sh->query("select sum(counts) as num from cmpai.pan_domain_zip_sh where uid={$uid} and audit_status=1");		$apply_count = $apply_ret[0]['num'];		$this->apply_count = $apply_count;				        //取目前用户名下的各品种个数        // $sql1="select count(*),b.name from cmpai.pan_domain_in a left join cmpai.new_ym_code b on a.typeid=b.code where uid=".$uid." and locked<5 group by typeid limit 6";        // $pres1=$pan_member_domain->findSql($sql1);        // $this->pres=$pres1;		        //最后登陆时间\\        $pan_user_log = spClass('pub_user_log');        $last_time = '';        $res = $pan_user_log->findAll(array("uid" => $uid), 'id desc', '*', 2);        if ($res) {            if (count($res) == 2) {                $last_time = date('Y-m-d H:i:s', $res[1]['logtime']);            } else {                $last_time = date('Y-m-d H:i:s', $res[0]['logtime']);            }        }        $this->last_time = $last_time;        //最后登陆时间\\		        $member_account = spClass('lib_member_account');        $res = $member_account->find(array('uid' => $uid));        $m_ye = 0; //总余额        $m_kyye = 0; //可用余额        $m_djje = 0; //冻结金额        $m_draw = 0; //可提现金额        $m_no_draw = 0; //不可提现金额        if ($res) {            $m_ye = $res['balance']; //总余额            $m_ye = bcadd($m_ye,0,2);//总余额 强制转换成最多只保留两位小数点，防止精度误差	            $m_djje = $res['freeze_money']; //冻结金额            $m_djje = bcadd($m_djje,0,2); //冻结金额 //强制转换成最多只保留两位小数点，防止精度误差	            $m_kyye = $m_ye - $m_djje; //可用余额            $m_kyye = bcadd($m_kyye,0,2); //可用余额 //强制转换成最多只保留两位小数点，防止精度误差	            $m_no_draw = $res['draw'] < 0 ? 0 : $res['draw']; //不可提现金额            // $m_draw = ($m_kyye - $m_no_draw) < 0 ? 0 : ($m_kyye - $m_no_draw); // 可提现金额=可用金额-不可提现金额            $m_draw = bcadd($m_kyye,0,2);; // 可提现金额=可用金额-不可提现金额            if ($res['draw'] < 0) {//不可提现金额小于0时,强制更改为0                $member_account->update(array("uid" => $uid), array('draw' => 0));            }        }		//----计算查询出当前会员UID，总资产-------begin        // $new_ym_code = spClass('new_ym_code');        // $new_ym_code = $new_ym_code->findAll('state=1');        // $type_options = array();        // foreach ($new_ym_code as $k => $v) {                // $type_options[] = $v['code'];        // }		$jc_price = 0;		$type_options = get_type_list();		foreach($type_options as $v) {			$pan_domain_in = spClass('pan_domain_in'); //域名实盘米			$typeid = $v;			$r_p = cache_s('cm_typeid_'.$typeid.'_hq');			$price = $r_p['new_price']; //取出当前品种的最新成交价			$count = $pan_domain_in->findCount(array('uid'=>$uid,'typeid'=>$typeid)); //域名总数量			$c_price = $price * $count; //总市值			$jc_price += $c_price;		}		$jc_price = bcadd($m_ye,$jc_price,2);//加上帐号总余额		//----计算查询出当前会员UID，总资产-------end				//----计算查询出当前会员UID，总积分-------begin		$pan_member_score = spClass('pan_member_score');		$score_ = $pan_member_score->query("select sum(balance) as balance from cmpai.pan_member_score where uid = $uid");		$score_balance = bcadd($score_[0]['balance'],0,2);					//----计算查询出当前会员UID，总积分-------end				//----计算查询出当前会员UID，明日的续费费用-------begin        // $new_ym_code = spClass('new_ym_code');        // $new_ym_code = $new_ym_code->findAll('state=1');        // $type_options = array();        // foreach ($new_ym_code as $k => $v) {                // $type_options[] = $v['code'];        // }	$renew_price = 0;		// foreach($type_options as $v) {			// $pan_domain_in = spClass('pan_domain_in'); //域名实盘米			// $pan_renew_price = spClass('pan_renew_price'); //价格表			// $typeid = $v;			// $r_p = $pan_renew_price->find(array('typeid'=>$typeid)); 			// $price = $r_p['price']; //取出当前品种的每日续费价格(一个域名)				// $count = $pan_domain_in->findCount(array('uid'=>$uid,'typeid'=>$typeid)); //域名总数量			// $c_price = $price * $count; //总价格			// $renew_price += $c_price;		// }		//----计算查询出当前会员UID，明日的续费费用-------end			//------公告-----begin        $announce_ret = spClass('pub_announce')->find(array('id'=>49));		unset($announce_ret['content']);		unset($announce_ret['introduction']);        $announce_ret['update_time'] = date("Y/m/d",strtotime($announce_ret['update_time']));			$this->announce_ret=$announce_ret;        $announce_list_ret = spClass('pub_announce')->findAll(array('status'=>0),'id desc','*','3');			foreach($announce_list_ret as $v){			$v['update_time'] = date("Y-m-d",strtotime($v['update_time']));			$announce_list_ret_[] = $v;		}		$this->announce_list_ret=$announce_list_ret_;		//------公告-----end				//------站内信-----begin        $web_msg_ret = spClass('pub_web_msg')->findAll(array('to_uid'=>$uid),'id desc','*','3');			foreach($web_msg_ret as $v){			$v['to_time'] = date("Y-m-d",$v['to_time']);			$web_msg_ret_[] = $v;		}		$this->web_msg_ret = $web_msg_ret_;		//------站内信-----end	        //委托卖单        // $sal = "select a.name,b.* from cmpai.new_ym_code a,cmpai.pan_trade b where a.code=b.typeid and b.uid=$uid and status_1=0 order by b.status_1 asc,order_time desc limit 0,20;";        $sal = "select * from cmpai.pan_trade where uid=$uid and status_1=0 order by status_1 asc,order_time desc limit 0,20;";        $reg = spClass('pan_trade')->query($sal);		// var_dump($reg);		$ret = array();		foreach($reg as $r){			$pt = $zb = '-';			//处理平台			if($r['pingtai']=='1'){				$pt = '易名';			}elseif($r['pingtai']=='2'){				$pt = '爱名';				}elseif($r['pingtai']=='3'){				$pt = '阿里云';				}elseif($r['pingtai']=='1,2'){				$pt = '易名 爱名';				}elseif($r['pingtai']=='1,3'){				$pt = '易名 阿里云';				}elseif($r['pingtai']=='2,3'){				$pt = '爱名 阿里云';				}else{				$pt = '不限平台';				}				//处理质保时间			if($r['zhibao']==0){				$zb = '不限质保';				if($r['status_2']==0){					$zb = '<1个月';				}			}else{				$zhibao_tmp = $r['zhibao'];				$zb = '≥'.$zhibao_tmp.'个月';				}			$_n = check_pz($r['typeid']);			$r['name'] = $_n[0]['name'];			// if($r['order_time']>='2017-11-02')$r['pt_zb'] = $pt.' '.$zb;			if($r['order_time']>='2017-11-02')$r['pt_zb'] = $zb;			$ret[] = $r; 		}				        $this->reg = $ret;        $this->m_res = $res;        $this->m_ye = $m_ye;        $this->m_kyye = $m_kyye;        $this->m_djje = $m_djje;        $this->m_draw = $m_draw;        $this->renew_price = $renew_price;        $this->jc_price = number_format($jc_price,2);        $this->score_balance = number_format($score_balance,2);               $this->module = "index";        $this->display('amui/member/am_index.html');    }}